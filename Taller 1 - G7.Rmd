```{r setup, include=FALSE}
gc(rm(list = ls()))
knitr::opts_chunk$set(echo = TRUE)

require(pacman)
p_load(stringr, # html to text
       tidyverse, # tidy-data
       skimr, # summary data
       rvest, # Web scrapping
       dplyr, # managing tables
       corrplot,#Correlation plot
       reshape2,
       boot,
       car,
       lmtest,
       caret) 
```

## 1. Introduction

In the public sector, accurate reporting of individual income is
critical for computing taxes. However, tax fraud of all kinds has always
been a significant issue. According to the Internal Revenue Service
(IRS), about 83.6% of taxes are paid voluntarily and on time in the
US.1. One of the causes of this gap is the under-reporting of incomes by
individuals. An income predicting model could potentially assist in
agging cases of fraud that could lead to the reduction of the gap.
Furthermore, an income prediction model can help identify vulnerable
individuals and families that may need further assistance.

The objective of the problem set is to generate a predictive model on
income levels based on Bogota's information about employed adults (\>18
years old). Thus, we can predict levels of income and then estimate a
level of tax payment. For this objective the survey of 2018 GEIH from
DANE, will be used.

2.a) (Describe the process of acquiring the data and if there are any
restrictions to accessing/scraping these data.) For scrapping this data
we will use ignaciomsarmiento repository and rvest to read the htmls. As
this data frames are html tables, we will also use dplyr.

<div>

```{r 2.b) Scrapping}
    # Link
    base <- "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_"
    htmls <- paste0(base,"page_",1:10, ".html")

    tables_list <- list()
    for (url in htmls) {
      web_page <- read_html(url)
      table <- web_page %>%
        html_nodes("table.table-striped") %>%
        html_table(fill = TRUE)
      tables_list[[url]] <- table
    }

    db = bind_rows(tables_list) %>% select(-...1)
    rm(tables_list,web_page,table,base,htmls,url)
```

</div>

2.  Describe the data briefly, including its purpose, and any other
    relevant information.

## 2. Data proccessing

We will use the definition the variable "ocu" already included on the
data set which takes value 1 if the person is occupied (employed) and 0
otherwise.

```{r Cleaning of data set, echo=FALSE}
# Filtering > 18 and occupied
db2 <- db %>% filter(age > 18, ocu == 1)

#------------ FRAMING MISSING VALUES -------------------------------------------

Nobs <- nrow(db2) 
db_miss <- data.frame(
  Variable = names(db2),
  n_missing = colSums(is.na(db2)),
  p_missing = round(colSums(100*is.na(db2))/Nobs,2)
) 
rownames(db_miss) <- NULL
View(db_miss)

# Attaching question content
question <- read_html("https://ignaciomsarmiento.github.io/GEIH2018_sample/dictionary.html")
question <- question %>%
        html_nodes("table") %>%
        html_table(fill = TRUE)
question = bind_rows(question)
db_miss <- left_join(question, db_miss, by = "Variable")
db_miss <- db_miss %>% arrange(desc(p_missing)) %>% filter(p_missing != 0) 
db_miss

# As we can see, almost 99/177 variables have more than 20% of the sample missing. 
# Yet, many of these variables are associated with non-occupied people and are not
# relevant for this exercise. Others, are the same variable with different scales 
# (example: monthly salary vs hourly salary). Thus, we're only going to keep the following variables:

#db2 <- db2 %>%
#  select(p6750,p7505, y_ingLab_m, y_salary_m, y_total_m, impa, isa, iof1, iof2, iof3h, iof3i, iof6, 
#         ingtotes, ingtotob, ingtot, y_bonificaciones_m, y_gananciaNeta_m, 
#         y_gananciaNetaAgro_m, y_primaNavidad_m, y_primaServicios_m, y_primaVacaciones_m, 
#         maxEducLevel, directorio, secuencia_p, orden, clase, dominio, mes, estrato1, 
#         sex, age, p6050, p6090, p6100, oficio, fex_c, depto, fex_dpto, fweight, informal)


# We will keep all of this variables just to be sure the answers are consistent. For example: if an individual
# answered they were occupied or employed a source of labor income should be perceived.


#------------ DATA CLEANING PROCESS: CONSISTENCY -------------------------------

# Data description: Consistency of answers. Occupied must be equal to the sum of formal + informal. 
# We'll. Employed vs Informal.   (Check)
Occupied_description <- db2 %>%
  group_by(p6240) %>%
  summarise(across(c(ocu, formal, informal), sum, na.rm = TRUE)) %>%
  ungroup() %>%
  add_row(p6240 = NA, 
          ocu = sum(.$ocu), 
          formal = sum(.$formal), 
          informal = sum(.$informal)) %>%
  mutate(Occupation = if_else(is.na(p6240), "Total",
                              recode(as.character(p6240),
                                     `6` = "Other activity",
                                     `5` = "Permanently unable to work",
                                     `4` = "Domestic work",
                                     `3` = "Studying",
                                     `2` = "Looking for work",
                                     `1` = "Working"))) %>%
  select(Occupation, ocu, formal, informal) %>%
  mutate(across(c(ocu, formal, informal), ~ . / last(ocu) * 100))
Occupied_description <- Occupied_description[-c(7),]
View(Occupied_description)

####  Export 
Occupied_description <- Occupied_description %>%
  mutate(across(c(ocu, formal, informal), ~ sprintf("%.2f", .x)))
stargazer(Occupied_description, summary = FALSE, type = "latex", rownames = FALSE)

# As we can see, most of income comes from either Working, Other activity or Domestic work. We're going to explore this income source individually. 
# Now, eventhought 86% of the sample reported income came from work, 40% of the income data related to work seems to be missing. 


#------------ DATA CLEANING PROCESS: CHOOSING INCOME ---------------------------
### On the first place we're going to check differences of imputed variables vs observed variables. 
obs_vars <- c("ie", "imdi", "impa", "ingtot", "iof1", "iof2", "iof3h", "iof3i", "iof6", "isa")
imp_vars <- c("iees", "imdies", "impaes", "ingtotes", "iof1es", "iof2es", "iof3hes", "iof3ies", "iof6es", "isaes")
titles   <- c("Especie", "Labor income non-occupied", "Main Activity", "Total", 
              "Interes and dividends", "Retirement", "Household Aid", "Institutional Aid", 
              "Real State", "Second Activity")

Stats <- mapply(function(ob, im, title) {
  obs <- db[[ob]]; imp <- db[[im]]
  q_obs <- quantile(obs, c(0.05, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE)
  q_imp <- quantile(imp, c(0.05, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE)
  data.frame(
    Statistic = c("Mean", "SD", "NA values", paste0("Quantile_", c(5, 25, 50, 75, 95)), "p-value"),
    Obs = c(mean(obs, na.rm = TRUE), sd(obs, na.rm = TRUE), sum(is.na(obs)), round(q_obs, 2), NA),
    Imp = c(mean(imp, na.rm = TRUE), sd(imp, na.rm = TRUE), sum(is.na(imp)), round(q_imp, 2), round(t.test(obs, imp, paired = TRUE)$p.value, 4))
  ) %>% rename_with(~ paste0(title, "_", sub("^(Obs|Imp)$", "\\1", .x)), Obs:Imp)
}, obs_vars, imp_vars, titles, SIMPLIFY = FALSE)

Obs_vs_Imp <- Reduce(function(x, y) merge(x, y, by = "Statistic", sort = FALSE), Stats)

# As we observe Imputed variables complement observed values on certain 
# observations. Thus, we will create a single subset that contains the imputed and the
# observed data
for(i in seq_along(obs_vars)) {
  new_name <- paste0(obs_vars[i], "_oi")
  db[[new_name]] <- ifelse(!is.na(db[[imp_vars[i]]]), db[[imp_vars[i]]], db[[obs_vars[i]]])
}

# We're goin to compare constructed vairables (starting with y) with our concatenation
# of observe and imputed
```

